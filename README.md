# PDF2MD - PDF to Markdown Converter (v3.0)

PDFファイルをMarkdown形式に変換するWindowsデスクトップアプリケーションです。

**PyMuPDF** と **EasyOCR** を使用して、テキスト・表・画像を高精度に抽出し、文書構造を保持したMarkdown変換を実現します。

## 主な機能

### 基本機能
- **テキスト抽出**: PDFからテキストを位置情報付きで抽出
- **画像抽出**: PDF内の図・画像を自動的に抽出して保存
- **OCR対応**: 図内のテキストをOCRで認識（日本語・英語対応）
- **位置保持**: テキストと画像と表の位置関係を正確にMarkdownに反映

### 高度な構造認識 (v3.0新機能)
- **高度な表検出**: 罫線あり/なし両方の表を検出してMarkdownテーブル形式に変換
- **見出し階層自動認識**: 文書全体のフォントサイズを分析して見出しレベル（H1-H6）を自動判定
- **リスト構造認識**: 箇条書き・番号付きリストの階層を保持
- **図表キャプション対応**: 「図1」「表1」などのキャプションを自動検出して紐付け
- **罫線なし表検出**: テキスト位置から表構造を推定（データ一覧など）

### 使いやすさ
- **GUI対応**: 直感的なグラフィカルインターフェース
- **ドラッグ&ドロップ**: PDFファイルをウィンドウにドロップして追加
- **バッチ処理**: 複数ファイルの一括変換
- **CLIモード**: コマンドラインからも使用可能

## スクリーンショット

```
+------------------------------------------+
|      PDF to Markdown Converter           |
+------------------------------------------+
| [ファイル追加] [フォルダ追加] [クリア] [変換実行] |
+------------------------------------------+
|   [x] 画像を抽出   [x] OCR（図内テキスト認識） |
+------------------------------------------+
| ファイルパス                    | 状態    |
|--------------------------------|---------|
| C:\docs\sample.pdf             | 待機中   |
| C:\docs\manual.pdf             | 完了     |
+------------------------------------------+
| ○ 同じフォルダに出力                      |
| ○ 指定フォルダに出力: [          ] [参照] |
+------------------------------------------+
| [================    ] 60%               |
| 変換中: manual.pdf                        |
+------------------------------------------+
```

## インストール

### 方法1: EXEファイルを使用（推奨）

1. [Releases](https://github.com/atsushisuemitsu/PDF2MD/releases) から最新の `PDF2MD.exe` をダウンロード
2. ダウンロードしたEXEを実行

### 方法2: Pythonから実行

```bash
# リポジトリをクローン
git clone https://github.com/atsushisuemitsu/PDF2MD.git
cd PDF2MD

# 依存関係をインストール
pip install -r requirements.txt

# 実行
python pdf2md.py
```

## 使い方

### GUIモード

1. `PDF2MD.exe` をダブルクリックして起動
2. 「ファイル追加」または「フォルダ追加」でPDFを選択
   - またはPDFファイルをウィンドウにドラッグ&ドロップ
3. オプションを設定:
   - **画像を抽出**: チェックするとPDF内の画像を別ファイルとして保存
   - **OCR**: チェックすると画像内のテキストをOCRで認識してMarkdownに含める
4. 必要に応じて出力先を設定
5. 「変換実行」をクリック

### CLIモード

```bash
# 単一ファイル変換（画像抽出あり）
python pdf2md.py document.pdf

# 複数ファイル変換
python pdf2md.py file1.pdf file2.pdf file3.pdf

# フォルダ内の全PDFを変換
python pdf2md.py ./pdf_folder/

# OCRを有効にして変換
python pdf2md.py --ocr document.pdf

# 画像抽出を無効にして変換
python pdf2md.py --no-images document.pdf
```

## 出力例

変換すると以下のファイルが生成されます：

```
input_folder/
├── manual.pdf          # 元のPDF

output_folder/
├── manual.md           # 変換されたMarkdown
└── manual_images/      # 抽出された画像
    ├── page1_img1.png
    ├── page1_img2.png
    └── page2_img1.png
```

### Markdownの出力形式

```markdown
# タイトル

## 第1章 概要

テキストの内容がここに出力されます。

### 1.1 機能一覧

- 機能A: 説明文
  - サブ機能A-1
  - サブ機能A-2
- 機能B: 説明文

**表1: 設定項目一覧**

| 項目   | 説明       | 備考       |
| ------ | ---------- | ---------- |
| 設定A  | 値1        | -          |
| 設定B  | 値2        | オプション |

![図1: システム構成図](manual_images/page1_img1.png)

*図1: システム構成図*

<details>
<summary>図内テキスト（OCR）</summary>

```
フローチャートから認識されたテキスト
→ ステップ1
→ ステップ2
→ 完了
```

</details>

続きのテキスト内容...
```

## EXEのビルド方法

```bash
# 依存関係をインストール
pip install -r requirements.txt

# ビルド実行（Windows）
build.bat
# または
powershell -ExecutionPolicy Bypass -File build.ps1

# EXEは dist/PDF2MD.exe に生成されます
```

## 技術仕様

- **Python**: 3.9+
- **PDF解析**: PyMuPDF (fitz)
- **OCR**: EasyOCR（日本語・英語対応）
- **画像処理**: Pillow
- **GUI**: tkinter
- **D&D対応**: tkinterdnd2（オプション）
- **EXE化**: PyInstaller

## 変換の仕組み

### Stage 1: 文書構造分析
1. **PDF解析**: PyMuPDFでPDFを開き、各ページを解析
2. **フォント分析**: 文書全体のフォントサイズを収集・分析して見出し階層を推定
3. **本文サイズ特定**: 最も頻出するフォントサイズを本文として認識

### Stage 2: 要素抽出
4. **高度な表検出**: PyMuPDFの表検出 + テキスト位置ベースの罫線なし表検出
5. **テキストブロック抽出**: 表領域を除外してテキストを抽出
6. **画像抽出**: 画像をPNGファイルとして保存（50px未満のアイコンは除外）
7. **OCR処理**: EasyOCRで図内のテキストを認識

### Stage 3: 構造認識
8. **見出し判定**: フォントサイズ・ボールド属性から見出しレベル（H1-H6）を決定
9. **リスト認識**: マーカーパターン（●○・1.など）からリスト構造を検出
10. **キャプション紐付け**: 「図1」「表1」などを最も近い図表と関連付け

### Stage 4: Markdown生成
11. **位置ソート**: 全要素をページ順→Y座標順→X座標順でソート
12. **Markdown出力**: 構造情報を保持したMarkdown形式で出力

## 注意事項

- OCR機能を使用する場合、初回実行時にモデルファイル（約100MB）がダウンロードされます
- 大きな画像を含むPDFの場合、処理に時間がかかることがあります
- 複雑なレイアウトのPDFでは、位置関係が正確に再現されない場合があります

## 参考

- [PDFを高品質マークダウンに変換](https://note.com/suh_sunaneko/n/na6687b2e01c8)
- [PyMuPDF Documentation](https://pymupdf.readthedocs.io/)
- [EasyOCR](https://github.com/JaidedAI/EasyOCR)

## ライセンス

MIT License

## 更新履歴

### v3.0.0 (2025-01-07)
- **高度な文書構造分析**: 文書全体のフォントを分析して見出し階層を自動推定
- **罫線なし表検出**: テキスト位置ベースで表構造を検出（データ一覧等に対応）
- **リスト構造認識**: 箇条書き・番号付きリストの階層を正確に保持
- **図表キャプション対応**: 「図1」「表1」などを自動検出して図表と紐付け
- **見出しレベル自動判定**: H1-H6を相対的なフォントサイズから決定
- **小アイコン除外**: 50px未満の小さな画像（アイコン等）を自動除外
- コード構造の大幅なリファクタリング（専用クラスによるモジュール化）

### v2.1.0 (2025-01-07)
- 表検出・抽出機能を追加（PyMuPDFのfind_tables使用）
- 表領域とテキスト領域の重複排除
- Markdownテーブル形式での出力

### v2.0.0 (2025-01-07)
- 変換エンジンをPyMuPDFに変更
- 画像抽出機能を追加
- OCR機能を追加（EasyOCR、日本語・英語対応）
- 位置情報を保持したMarkdown生成
- GUI にオプションチェックボックスを追加

### v1.0.1 (2025-01-07)
- EXE化時のmagikaモデルファイル問題を修正
- PyInstaller specファイルを追加

### v1.0.0 (2025-01-07)
- 初回リリース
- GUI/CLIモード対応
- バッチ変換機能
- ドラッグ&ドロップ対応
